---
title: "Simple skeleton simulation"
author: "Martin Johnsson"
output: html_document
---

Simple simulation with these features:

* Discrete generations

* 3000 females, 200 males used each generation

* Selection only on the male side

* 6000 matings with equal sex ratio => 200 out of 3000 (3.3% of males used)

* One fully recessive lethal ~ 5% starting frequency

* No carrier x carrier matings; carrier x noncarrier matings allowed

## Housekeeping

Load packages and simulation results

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(AlphaSimR)
library(dplyr)
library(ggplot2)
library(purrr)
library(tidyr)

source("R/simulation_functions.R")
```

```{r}
filenames <- system("ls simulations/simple_simulations_balancing/results_*.Rds",
                    intern = TRUE)
n_reps <- length(filenames)
simulation_results <- lapply(filenames,
                             readRDS)
names(simulation_results) <- 1:n_reps
```

Generation counter

```{r}
generations <- 1:40
```


## Basic features of the simulation

Genetic trend

```{r}
stats <- map_df(simulation_results, function(x) x$stats)
stats$replicate <- rep(1:n_reps, each = length(generations))

qplot(x = generation,
      y = mean_g,
      colour = replicate,
      data = stats,
      xlab = "Generation",
      ylab = "Mean genetic value",
      main = "Genetic trend")
```

Genetic variance

```{r}
qplot(x = generation,
      y = var_g,
      data = stats,
      colour = replicate,
      xlab = "Generation",
      ylab = "Genetic variance",
      main = "Genetic variance trend")
```

## Allele frequency changes

Lethal allele frequency

```{r}
carriers <- map_df(simulation_results, function(x) x$carriers)
carriers$replicate <- rep(1:n_reps, each = length(generations))

qplot(x = generation,
      y = carriers/6400,
      data = carriers,
      colour = replicate,
      xlab = "Generation",
      ylab = "Lethal allele frequency",
      group = replicate,
      geom = "line") +
    ggtitle("Lethal allele frequency change with balancing selection")
```


# Relationship between variance explained and frequency

```{r}
founder_variance_explained <- unlist(lapply(simulation_results,
                                            "[",
                                            "founder_variance_explained_by_lethal"))
end_carriers <- do(group_by(carriers, replicate),
                   data.frame(average30_40 = mean(.$carriers[.$generation %in% 31:40])))
qplot(x = founder_variance_explained,
      y = end_carriers$average30_40/6400) +
    xlab("Variance explained in breeding goal in founder population") +
    ylab("Lethal allele frequency (in generations 31-40)")
```

```{r}
mean(end_carriers$average30_40/6400)
sd(end_carriers$average30_40/6400)
```


